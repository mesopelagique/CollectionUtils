<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<title>Unit test result</title>
	    <style type="text/css">
table {
    width: 90%;
}
th {
    background: #f1f1f1;
    font-weight: bold;
    padding: 6px;
}
td {
    background: #f9f9f9;
    padding: 6px;
}
.loader {
  animation: spin 2s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
        </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
	</head>

	<body bgcolor="#ffffff">
		<div align="center">
      <h1>Unit Tests</h1>
      <table id="myTable">
        <tr>
            <th onclick="thclick(this)">‚ñ∂Ô∏è</th>
            <th>Name</th>
            <th>Success</th>
            <th>Duration(ms)</th>
            <th>Message</th>
        </tr>
      </table>
      <script type="text/javascript">
        function executeTest(test, el) {
            console.log(test);

            var success=el.children().first().next().next();
            success.text("");
            success.append($('<div class="loader">üåÄ</div>'));

            $.ajax({
            url: '4daction/actionTest',
            type: 'POST',
            data: JSON.stringify({ "test": test }),
            dataType: 'json',
            success: function(data) {
                console.log(data);
                var value = data //[; test];
                var success=el.children().first().next().next();
                success.text(value.success ? '‚úÖ': 'üö´');
                var duration=success.next();
                duration.text(value.duration);
                var message=duration.next();
                if(value.formula) {
                    message.text(value.formula);
                } else {
                    message.text("");
                }
            },
            error: function(jqXHR, textStatus, errorThrown){
                alert('Error: ' + textStatus + ' - ' + errorThrown);
            }});
        };
        function tdclick(el){
            var test = $(el).next().text();
            executeTest(test, $(el).closest('tr'));
        };
        function thclick(el) {
            $header=$(el).closest('tr');

            $row=$header.next();
            while($row.length) {
                executeTest($row.children().first().next().text(), $row);
                $row=$row.next();
            }
        }
        $.ajax({
            url: '4daction/actionTests',
            dataType: 'json',
            success: function(data) {
                for (let [test, value] of Object.entries(data)) {
                    if (test == "success") { continue; }
                    var row = '<tr><td onclick="tdclick(this)" align="center" style="width:5%">‚ñ∂Ô∏è</td><td>' + test+ '</td><td align="center" style="width:10%">';
                    if (typeof value.success !== 'undefined') {
                        row += value.success ? '‚úÖ': 'üö´';
                    } else {
                        row += '-';
                    }
                    row += '</td><td align="center" style="width:10%">';  
                    if (value.duration) { 
                        row += value.duration;
                    }
                    row += '</td><td style="width:60%">';
                    if(value.formula) {
                      row +=  value.formula;
                    } 
                    row += '</td></tr>';

                    el=$(row)
                    $('#myTable').append(el);
                    if (typeof value.success === 'undefined') {
                       executeTest(test, el)
                    }
                }
            },
            error: function(jqXHR, textStatus, errorThrown){
                alert('Error: ' + textStatus + ' - ' + errorThrown);
            }
        });
        </script>
		</div>
	</body>

</html>
